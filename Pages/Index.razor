@page "/"
@using AwsHelper.Services
@inject ParameterStoreService ParamStore

<h3>Enviar Variáveis para o Parameter Store</h3>

<div class="d-flex gap-2 align-items-end">
    <div style="flex: 1;">
        <label>Perfil AWS:</label>
        <select class="form-control" @bind="SelectedProfile" disabled="@IsProcessing">
            @foreach (var profile in AvailableProfiles)
            {
                <option value="@profile">@profile</option>
            }
        </select>
    </div>

    <div style="flex: 2;">
        <label>Prefixo (caminho no Parameter Store):</label>
        <input type="text" placeholder="Ex: /clapsapi/dev/agendador" class="form-control" @bind="InputPath" disabled="@IsProcessing" />
    </div>
</div>

<br />

<label>Variáveis (chave=valor por linha):</label>
<textarea @bind="InputText" rows="10" class="form-control" disabled="@IsProcessing"></textarea>
<br />
<button class="btn btn-primary" @onclick="Upload" disabled="@IsProcessing">
    @(IsProcessing ? "Enviando..." : "Enviar")
</button>

<p>@Status</p>

@code {
    private string InputPath = "";
    private string InputText = "";
    private string Status = "";

    private List<string> AvailableProfiles = new();
    private string SelectedProfile = "";

    private bool IsProcessing = false;

    protected override void OnInitialized()
    {
        var credsFile = new Amazon.Runtime.CredentialManagement.SharedCredentialsFile();
        AvailableProfiles = credsFile.ListProfileNames().ToList();
        SelectedProfile = AvailableProfiles.FirstOrDefault() ?? "";
    }

    private async Task Upload()
    {
        try
        {
            Status = "";
            IsProcessing = true;

            var credsFile = new Amazon.Runtime.CredentialManagement.SharedCredentialsFile();
            if (!credsFile.TryGetProfile(SelectedProfile, out var profile))
            {
                Status = $"Perfil '{SelectedProfile}' não encontrado.";
                return;
            }

            var accessKey = profile.Options.AccessKey;
            var secretKey = profile.Options.SecretKey;

            await ParamStore.UploadVariablesAsync(InputText, InputPath, accessKey, secretKey);
            Status = "Variáveis enviadas com sucesso!";
        }
        catch (Exception ex)
        {
            Status = $"Erro: {ex.Message}";
        }
        finally
        {
            IsProcessing = false;
        }
    }
}