@page "/s3/objects/{BucketName}"
@using AwsHelper.Models
@using AwsHelper.Services
@inject S3Service S3Service
@inject AwsProfileService ProfileService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<S3ObjectsList> _logger

<PageTitle>@BucketName - Objetos S3 - AwsHelper</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="/s3/buckets">Buckets S3</a></li>
                            <li class="breadcrumb-item">
                                <a href="/s3/objects/@BucketName?profile=@selectedProfile">@BucketName</a>
                            </li>
                            @if (!string.IsNullOrEmpty(currentPath))
                            {
                                var pathParts = currentPath.Split('/').Where(p => !string.IsNullOrEmpty(p)).ToArray();
                                for (int i = 0; i < pathParts.Length; i++)
                                {
                                    var pathUpToHere = string.Join("/", pathParts.Take(i + 1));
                                    if (i == pathParts.Length - 1)
                                    {
                                        <li class="breadcrumb-item active" aria-current="page">@pathParts[i]</li>
                                    }
                                    else
                                    {
                                        <li class="breadcrumb-item">
                                            <a href="/s3/objects/@BucketName?profile=@selectedProfile&path=@pathUpToHere">@pathParts[i]</a>
                                        </li>
                                    }
                                }
                            }
                        </ol>
                    </nav>
                    <h1 class="h3 mb-1">
                        <span class="oi oi-folder me-2 text-primary"></span>
                        @BucketName
                        @if (!string.IsNullOrEmpty(currentPath))
                        {
                            <span class="text-muted">/@currentPath</span>
                        }
                    </h1>
                    <p class="text-muted mb-0">@browserItems?.Count itens encontrados</p>
                    @if (!string.IsNullOrEmpty(selectedProfile))
                    {
                        <small class="text-muted">
                            Perfil: <span class="badge bg-primary">@selectedProfile</span>
                        </small>
                    }
                </div>
                <div class="d-flex gap-2">
                    @if (!string.IsNullOrEmpty(currentPath))
                    {
                        <button class="btn btn-outline-secondary" @onclick="NavigateUp">
                            <span class="oi oi-arrow-top me-2"></span>
                            Pasta Anterior
                        </button>
                    }
                    <button class="btn btn-success" @onclick="OpenFileUpload" disabled="@(isLoading || string.IsNullOrEmpty(selectedProfile))">
                        <span class="oi oi-cloud-upload me-2"></span>
                        Enviar Arquivo
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="@(() => Navigation.NavigateTo("/s3/buckets"))">
                        <span class="oi oi-arrow-left me-2"></span>
                        Voltar aos Buckets
                    </button>
                    <button class="btn btn-primary" @onclick="LoadObjects" disabled="@(isLoading || string.IsNullOrEmpty(selectedProfile))">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        else
                        {
                            <span class="oi oi-reload me-2"></span>
                        }
                        Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (string.IsNullOrEmpty(selectedProfile))
    {
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <span class="oi oi-person me-2"></span>
                            Selecione o Perfil AWS
                        </h6>
                        <select class="form-select" @bind="selectedProfile" @bind:after="OnProfileChanged" disabled="@isLoading">
                            <option value="">-- Selecione um perfil --</option>
                            @foreach (var profile in availableProfiles)
                            {
                                <option value="@profile">@profile</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <span class="oi oi-magnifying-glass"></span>
                    </span>
                    <input type="text" class="form-control" placeholder="Filtrar por nome..." 
                           value="@searchTerm" @oninput="OnSearchChanged" />
                    @if (!string.IsNullOrEmpty(searchTerm))
                    {
                        <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                            <span class="oi oi-x"></span>
                        </button>
                    }
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <span class="oi oi-folder"></span>
                    </span>
                    <input type="text" class="form-control" placeholder="Navegar para pasta..." 
                           @bind="navigationPath" @onkeydown="OnNavigationKeyPress" @onkeydown:preventDefault="false" />
                    <button class="btn btn-outline-primary" type="button" @onclick="NavigateToPath">
                        Ir
                    </button>
                </div>
                <small class="text-muted mt-1 d-block">
                    Caminho atual: @(string.IsNullOrEmpty(currentPath) ? "/" : "/" + currentPath)
                </small>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Erro:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = string.Empty)"></button>
        </div>
    }

    @* Modal de Upload *@
    @if (showUploadModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="@(isUploading ? (Action)(() => {}) : CloseUploadModal)" @onclick:stopPropagation="true">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <span class="oi oi-cloud-upload me-2"></span>
                            Enviar Arquivo
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseUploadModal" disabled="@isUploading"></button>
                    </div>
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(uploadErrorMessage))
                        {
                            <div class="alert alert-danger">
                                <strong>Erro:</strong> @uploadErrorMessage
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(uploadSuccessMessage))
                        {
                            <div class="alert alert-success">
                                <span class="oi oi-check me-2"></span>
                                <strong>Sucesso:</strong> @uploadSuccessMessage
                            </div>
                        }
                        
                        @if (isUploading)
                        {
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <span class="spinner-border spinner-border-sm me-3" role="status"></span>
                                    <div>
                                        <strong>Enviando arquivo...</strong><br/>
                                        <small>@selectedFile?.Name (@FormatFileSize(selectedFile?.Size ?? 0))</small><br/>
                                        <small class="text-muted">Por favor, n√£o feche esta janela.</small>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        <div class="mb-3">
                            <label class="form-label">Pasta de destino:</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <span class="oi oi-folder"></span>
                                </span>
                                <input type="text" class="form-control" @bind="uploadPath" 
                                       placeholder="@(string.IsNullOrEmpty(currentPath) ? "Raiz do bucket" : currentPath)" 
                                       disabled="@isUploading" />
                            </div>
                            <small class="text-muted">Deixe vazio para enviar para: @(string.IsNullOrEmpty(currentPath) ? "/" : "/" + currentPath)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Selecionar arquivo:</label>
                            <input type="file" id="fileUploadInput" class="form-control" 
                                   @onchange="OnFileSelected" disabled="@isUploading" />
                            @if (selectedFile != null)
                            {
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Arquivo:</strong> @selectedFile.Name<br/>
                                        <strong>Tamanho:</strong> @FormatFileSize(selectedFile.Size)<br/>
                                        <strong>Tipo:</strong> @selectedFile.Type
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseUploadModal" disabled="@isUploading">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-success" @onclick="UploadFile" disabled="@(isUploading || selectedFile == null)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            else
                            {
                                <span class="oi oi-cloud-upload me-2"></span>
                            }
                            Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal de Confirma√ß√£o de Substitui√ß√£o *@
    @if (showConfirmationModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick:stopPropagation="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <span class="oi oi-warning me-2"></span>
                            Arquivo j√° existe
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning mb-3">
                            <span class="oi oi-warning me-2"></span>
                            <strong>Aten√ß√£o!</strong> J√° existe um arquivo com o nome <strong>@existingFileName</strong> neste local.
                        </div>
                        <p>O que voc√™ deseja fazer?</p>
                        <ul class="mb-0">
                            <li><strong>Substituir:</strong> O arquivo existente ser√° sobrescrito pelo novo arquivo.</li>
                            <li><strong>Cancelar:</strong> O upload ser√° cancelado e o arquivo existente ser√° mantido.</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelUpload">
                            <span class="oi oi-x me-2"></span>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-warning" @onclick="ConfirmOverwrite">
                            <span class="oi oi-loop-circular me-2"></span>
                            Substituir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Modal de Confirma√ß√£o de Exclus√£o *@
    @if (showDeleteConfirmationModal && objectToDelete != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick:stopPropagation="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <span class="oi oi-trash me-2"></span>
                            Confirmar Exclus√£o
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger mb-3">
                            <span class="oi oi-warning me-2"></span>
                            <strong>Aten√ß√£o!</strong> Esta a√ß√£o n√£o pode ser desfeita.
                        </div>
                        <p>Voc√™ tem certeza que deseja excluir o arquivo:</p>
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title mb-1">
                                    <span class="oi oi-document me-2"></span>
                                    @objectToDelete.FileName
                                </h6>
                                <small class="text-muted">
                                    <span class="oi oi-data-transfer-download me-1"></span>
                                    @FormatFileSize(objectToDelete.Size) ‚Ä¢ 
                                    <span class="oi oi-clock me-1"></span>
                                    @objectToDelete.LastModified.ToString("dd/MM/yyyy HH:mm")
                                </small>
                            </div>
                        </div>
                        <p class="mt-3 mb-0">
                            <strong>O arquivo ser√° permanentemente removido do bucket S3.</strong>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete" disabled="@isDeleting">
                            <span class="oi oi-x me-2"></span>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            else
                            {
                                <span class="oi oi-trash me-2"></span>
                            }
                            Excluir Arquivo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    }
    else if (string.IsNullOrEmpty(selectedProfile))
    {
        <div class="text-center py-5">
            <div class="mb-3">
                <span class="oi oi-person display-4 text-muted"></span>
            </div>
            <h4 class="text-muted">Selecione um Perfil AWS</h4>
            <p class="text-muted">Para visualizar os objetos, primeiro selecione um perfil AWS v√°lido.</p>
        </div>
    }
    else if (filteredBrowserItems?.Any() == true)
    {
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="cursor: pointer;" @onclick="() => ToggleSort(SortField.Name)">
                                <span class="oi oi-document me-2"></span>
                                Nome
                                @if (currentSortField == SortField.Name)
                                {
                                    <span class="oi @(isAscending ? "oi-caret-top" : "oi-caret-bottom") ms-1"></span>
                                }
                            </th>
                            <th style="cursor: pointer;" @onclick="() => ToggleSort(SortField.LastModified)">
                                <span class="oi oi-clock me-2"></span>
                                √öltima Modifica√ß√£o
                                @if (currentSortField == SortField.LastModified)
                                {
                                    <span class="oi @(isAscending ? "oi-caret-top" : "oi-caret-bottom") ms-1"></span>
                                }
                            </th>
                            <th style="cursor: pointer;" @onclick="() => ToggleSort(SortField.Size)">
                                <span class="oi oi-data-transfer-download me-2"></span>
                                Tamanho
                                @if (currentSortField == SortField.Size)
                                {
                                    <span class="oi @(isAscending ? "oi-caret-top" : "oi-caret-bottom") ms-1"></span>
                                }
                            </th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in filteredBrowserItems)
                        {
                            <tr>
                                <td class="align-middle">
                                    <div class="d-flex align-items-center">
                                        @if (item.IsFolder)
                                        {
                                            <span class="oi oi-folder me-2 text-warning"></span>
                                            <button class="btn btn-link p-0 fw-medium text-decoration-none" 
                                                    @onclick="@(() => NavigateToFolder(item.FullPath))">
                                                @item.Name/
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="oi oi-document me-2 text-muted"></span>
                                            <span class="fw-medium">@item.Name</span>
                                        }
                                    </div>
                                </td>
                                <td class="align-middle">
                                    @if (item.IsFolder)
                                    {
                                        <small class="text-muted">Pasta</small>
                                    }
                                    else
                                    {
                                        <small>@item.File!.LastModified.ToString("dd/MM/yyyy HH:mm:ss")</small>
                                    }
                                </td>
                                <td class="align-middle">
                                    @if (item.IsFolder)
                                    {
                                        <span class="badge bg-light text-dark">@item.Folder!.FileCount arquivo(s)</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-light text-dark">@item.File!.SizeFormatted</span>
                                    }
                                </td>
                                <td class="align-middle">
                                    @if (item.IsFolder)
                                    {
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                @onclick="@(() => NavigateToFolder(item.FullPath))">
                                            <span class="oi oi-folder me-1"></span>
                                            Abrir
                                        </button>
                                    }
                                    else
                                    {
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                    @onclick="@(() => DownloadObject(item.File!))" 
                                                    disabled="@(downloadingObjects.Contains(item.File!.Key))">
                                                @if (downloadingObjects.Contains(item.File!.Key))
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                }
                                                else
                                                {
                                                    <span class="oi oi-data-transfer-download me-1"></span>
                                                }
                                                Download
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                    @onclick="@(() => ConfirmDeleteObject(item.File!))"
                                                    disabled="@(downloadingObjects.Contains(item.File!.Key) || isDeleting)">
                                                @if (deletingObjects.Contains(item.File!.Key))
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                }
                                                else
                                                {
                                                    <span class="oi oi-trash me-1"></span>
                                                }
                                                Excluir
                                            </button>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else if (!isLoading && !string.IsNullOrEmpty(selectedProfile))
    {
        <div class="text-center py-5">
            <div class="mb-3">
                <span class="oi oi-info display-4 text-muted"></span>
            </div>
            <h4 class="text-muted">Nenhum objeto encontrado</h4>
            <p class="text-muted">
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <span>N√£o foram encontrados itens com os filtros aplicados.</span>
                }
                else
                {
                    <span>Esta pasta n√£o cont√©m itens ou voc√™ n√£o tem permiss√£o para visualiz√°-los.</span>
                }
            </p>
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button class="btn btn-primary" @onclick="ClearFilters">
                    <span class="oi oi-reload me-2"></span>
                    Limpar Filtros
                </button>
            }
        </div>
    }
</div>

@code {
    public enum SortField
    {
        Name,
        LastModified,
        Size
    }

    [Parameter] public string BucketName { get; set; } = string.Empty;
    [SupplyParameterFromQuery] public string? Profile { get; set; }
    [SupplyParameterFromQuery] public string? Path { get; set; }

    private List<S3Object>? objects;
    private List<S3BrowserItem>? browserItems;
    private List<S3BrowserItem>? filteredBrowserItems;
    private List<string> availableProfiles = new();
    private string selectedProfile = string.Empty;
    private string currentPath = string.Empty;
    private string navigationPath = string.Empty;
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private string searchTerm = string.Empty;
    private HashSet<string> downloadingObjects = new();
    private HashSet<string> deletingObjects = new();
    private bool isDeleting = false;
    
    // Vari√°veis para ordena√ß√£o
    private SortField currentSortField = SortField.Name;
    private bool isAscending = true;

    // Vari√°veis para upload
    private bool showUploadModal = false;
    private bool isUploading = false;
    private string uploadErrorMessage = string.Empty;
    private string uploadSuccessMessage = string.Empty;
    private string uploadPath = string.Empty;
    private FileInfo? selectedFile = null;

    // Vari√°veis para confirma√ß√£o de substitui√ß√£o
    private bool showConfirmationModal = false;
    private string existingFileName = string.Empty;

    // Vari√°veis para confirma√ß√£o de exclus√£o
    private bool showDeleteConfirmationModal = false;
    private S3Object? objectToDelete = null;

    public class FileInfo
    {
        public string Name { get; set; } = string.Empty;
        public long Size { get; set; }
        public string Type { get; set; } = string.Empty;
        public long LastModified { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProfiles();
        
        // Se o perfil foi passado como par√¢metro da URL, use-o
        if (!string.IsNullOrEmpty(Profile))
        {
            selectedProfile = Profile;
        }
        
        // Se o caminho foi passado como par√¢metro da URL, use-o
        if (!string.IsNullOrEmpty(Path))
        {
            currentPath = Path;
            navigationPath = Path;
        }
        
        if (!string.IsNullOrEmpty(selectedProfile))
        {
            await LoadObjects();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(BucketName) && !string.IsNullOrEmpty(selectedProfile))
        {
            await LoadObjects();
        }
    }

    private async Task LoadProfiles()
    {
        try
        {
            availableProfiles = ProfileService.GetAvailableProfiles();
            
            if (string.IsNullOrEmpty(selectedProfile) && availableProfiles.Any())
            {
                selectedProfile = availableProfiles.First();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar perfis: {ex.Message}";
        }
    }

    private async Task OnProfileChanged()
    {
        // Limpar objetos sempre que o perfil mudar
        objects = null;
        browserItems = null;
        filteredBrowserItems = null;
        errorMessage = string.Empty;
        
        if (!string.IsNullOrEmpty(selectedProfile))
        {
            await LoadObjects();
        }
    }

    private async Task LoadObjects()
    {
        if (string.IsNullOrEmpty(selectedProfile))
        {
            errorMessage = "Por favor, selecione um perfil AWS v√°lido.";
            objects = null;
            browserItems = null;
            filteredBrowserItems = null;
            return;
        }

        // Verificar se o perfil existe antes de tentar usar
        if (!ProfileService.ProfileExists(selectedProfile))
        {
            errorMessage = $"O perfil '{selectedProfile}' n√£o foi encontrado ou √© inv√°lido.";
            objects = null;
            browserItems = null;
            filteredBrowserItems = null;
            return;
        }

        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            objects = null; // Limpar objetos antes de carregar novos
            browserItems = null;
            filteredBrowserItems = null;
            StateHasChanged();

            // Carregar objetos com prefixo baseado no caminho atual
            var prefix = string.IsNullOrEmpty(currentPath) ? "" : currentPath + "/";
            objects = await S3Service.ListObjectsAsync(selectedProfile, BucketName, prefix, 10000);
            
            BuildBrowserItems();
            FilterBrowserItems();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar objetos: {ex.Message}";
            objects = null; // Garantir que objetos sejam limpos em caso de erro
            browserItems = null;
            filteredBrowserItems = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        FilterBrowserItems();
    }

    private async Task OnNavigationKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            // Aguardar um pouco para garantir que o @bind seja processado
            await Task.Delay(50);
            await NavigateToPath();
        }
    }

    private void BuildBrowserItems()
    {
        if (objects == null)
        {
            browserItems = null;
            return;
        }

        var items = new List<S3BrowserItem>();
        var folders = new Dictionary<string, S3Folder>();
        var currentPrefix = string.IsNullOrEmpty(currentPath) ? "" : currentPath + "/";

        foreach (var obj in objects)
        {
            // Remover o prefixo atual do key para obter o caminho relativo
            var relativePath = obj.Key.StartsWith(currentPrefix) ? obj.Key.Substring(currentPrefix.Length) : obj.Key;
            
            // Se est√° vazio, pular (√© um objeto na raiz com o mesmo nome da pasta)
            if (string.IsNullOrEmpty(relativePath))
                continue;

            // Verificar se tem mais barras (√© um subdiret√≥rio)
            var slashIndex = relativePath.IndexOf('/');
            
            if (slashIndex > 0)
            {
                // √â uma pasta
                var folderName = relativePath.Substring(0, slashIndex);
                var folderPath = string.IsNullOrEmpty(currentPath) ? folderName : currentPath + "/" + folderName;
                
                if (!folders.ContainsKey(folderName))
                {
                    folders[folderName] = new S3Folder
                    {
                        Name = folderName,
                        FullPath = folderPath,
                        FileCount = 0,
                        TotalSize = 0
                    };
                }
                
                folders[folderName].FileCount++;
                folders[folderName].TotalSize += obj.Size;
            }
            else
            {
                // √â um arquivo
                items.Add(new S3BrowserItem
                {
                    Name = relativePath,
                    FullPath = obj.Key,
                    IsFolder = false,
                    File = obj
                });
            }
        }

        // Adicionar pastas
        foreach (var folder in folders.Values)
        {
            items.Add(new S3BrowserItem
            {
                Name = folder.Name,
                FullPath = folder.FullPath,
                IsFolder = true,
                Folder = folder
            });
        }

        // Ordenar: pastas primeiro, depois arquivos
        browserItems = items.OrderBy(i => !i.IsFolder).ThenBy(i => i.Name).ToList();
    }

    private void FilterBrowserItems()
    {
        if (browserItems == null)
        {
            filteredBrowserItems = null;
            return;
        }

        var filtered = browserItems.Where(item =>
            string.IsNullOrEmpty(searchTerm) ||
            item.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
        );

        // Aplicar ordena√ß√£o
        filtered = ApplySorting(filtered);

        filteredBrowserItems = filtered.ToList();
        StateHasChanged();
    }

    private IEnumerable<S3BrowserItem> ApplySorting(IEnumerable<S3BrowserItem> items)
    {
        var folders = items.Where(i => i.IsFolder);
        var files = items.Where(i => !i.IsFolder);

        // Para ordena√ß√£o por √∫ltima modifica√ß√£o, priorizar arquivos sobre pastas
        if (currentSortField == SortField.LastModified)
        {
            // Ordenar arquivos por data de modifica√ß√£o
            files = isAscending ? files.OrderBy(f => f.File!.LastModified) : files.OrderByDescending(f => f.File!.LastModified);
            
            // Ordenar pastas por nome (j√° que n√£o t√™m data)
            folders = isAscending ? folders.OrderBy(f => f.Name) : folders.OrderByDescending(f => f.Name);
            
            // Retornar arquivos primeiro, depois pastas
            return files.Concat(folders);
        }
        else
        {
            // Para outras ordena√ß√µes, manter pastas primeiro
            // Ordenar pastas
            folders = currentSortField switch
            {
                SortField.Name => isAscending ? folders.OrderBy(f => f.Name) : folders.OrderByDescending(f => f.Name),
                SortField.Size => isAscending ? folders.OrderBy(f => f.Folder!.FileCount) : folders.OrderByDescending(f => f.Folder!.FileCount),
                _ => folders.OrderBy(f => f.Name)
            };

            // Ordenar arquivos
            files = currentSortField switch
            {
                SortField.Name => isAscending ? files.OrderBy(f => f.Name) : files.OrderByDescending(f => f.Name),
                SortField.Size => isAscending ? files.OrderBy(f => f.File!.Size) : files.OrderByDescending(f => f.File!.Size),
                _ => files.OrderBy(f => f.Name)
            };

            // Retornar pastas primeiro, depois arquivos
            return folders.Concat(files);
        }
    }

    private void ToggleSort(SortField field)
    {
        if (currentSortField == field)
        {
            isAscending = !isAscending;
        }
        else
        {
            currentSortField = field;
            isAscending = true;
        }

        FilterBrowserItems();
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        FilterBrowserItems();
    }

    private async Task ClearFilters()
    {
        searchTerm = string.Empty;
        await LoadObjects();
    }

    private async Task NavigateToFolder(string folderPath)
    {
        currentPath = folderPath;
        navigationPath = folderPath;
        Navigation.NavigateTo($"/s3/objects/{BucketName}?profile={selectedProfile}&path={folderPath}");
        await LoadObjects();
    }

    private async Task NavigateToPath()
    {
        // Limpar espa√ßos em branco e normalizar o caminho
        navigationPath = navigationPath?.Trim() ?? string.Empty;
        
        // Se o caminho come√ßa com "/", remover
        if (navigationPath.StartsWith("/"))
        {
            navigationPath = navigationPath.Substring(1);
        }
        
        // Se o caminho termina com "/", remover
        if (navigationPath.EndsWith("/") && navigationPath.Length > 0)
        {
            navigationPath = navigationPath.Substring(0, navigationPath.Length - 1);
        }
        
        currentPath = navigationPath;
        
        // Construir URL adequada
        var url = string.IsNullOrEmpty(currentPath) ? 
            $"/s3/objects/{BucketName}?profile={selectedProfile}" : 
            $"/s3/objects/{BucketName}?profile={selectedProfile}&path={currentPath}";
            
        Navigation.NavigateTo(url);
        await LoadObjects();
    }

    private async Task NavigateUp()
    {
        if (string.IsNullOrEmpty(currentPath))
            return;

        var lastSlash = currentPath.LastIndexOf('/');
        if (lastSlash > 0)
        {
            currentPath = currentPath.Substring(0, lastSlash);
            navigationPath = currentPath;
        }
        else
        {
            currentPath = string.Empty;
            navigationPath = string.Empty;
        }

        var url = string.IsNullOrEmpty(currentPath) ? 
            $"/s3/objects/{BucketName}?profile={selectedProfile}" : 
            $"/s3/objects/{BucketName}?profile={selectedProfile}&path={currentPath}";
        
        Navigation.NavigateTo(url);
        await LoadObjects();
    }

    private async Task DownloadObject(S3Object obj)
    {
        if (string.IsNullOrEmpty(selectedProfile))
        {
            errorMessage = "Perfil AWS n√£o selecionado.";
            return;
        }

        try
        {
            downloadingObjects.Add(obj.Key);
            StateHasChanged();

            using var stream = await S3Service.DownloadObjectAsync(selectedProfile, BucketName, obj.Key);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            
            var base64 = Convert.ToBase64String(memoryStream.ToArray());
            var fileName = obj.FileName;
            
            await JSRuntime.InvokeVoidAsync("downloadFile", base64, fileName);
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao baixar arquivo {obj.FileName}: {ex.Message}";
        }
        finally
        {
            downloadingObjects.Remove(obj.Key);
            StateHasChanged();
        }
    }

    private void OpenFileUpload()
    {
        showUploadModal = true;
        uploadErrorMessage = string.Empty;
        uploadSuccessMessage = string.Empty;
        selectedFile = null;
        uploadPath = currentPath;
    }

    private void CloseUploadModal()
    {
        showUploadModal = false;
        showConfirmationModal = false;
        showDeleteConfirmationModal = false;
        uploadErrorMessage = string.Empty;
        uploadSuccessMessage = string.Empty;
        selectedFile = null;
        uploadPath = string.Empty;
        existingFileName = string.Empty;
        objectToDelete = null;
    }

    private async Task OnFileSelected()
    {
        try
        {
            var fileInfo = await JSRuntime.InvokeAsync<FileInfo?>("getFileInfo", "fileUploadInput");
            selectedFile = fileInfo;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            uploadErrorMessage = $"Erro ao selecionar arquivo: {ex.Message}";
        }
    }

    private async Task UploadFile()
    {
        if (selectedFile == null)
        {
            uploadErrorMessage = "Nenhum arquivo selecionado.";
            return;
        }

        if (selectedFile.Size > 100 * 1024 * 1024) // 100MB
        {
            uploadErrorMessage = "Arquivo muito grande. O tamanho m√°ximo permitido √© 100MB.";
            return;
        }

        // Construir chave do objeto
        var objectKey = string.IsNullOrEmpty(uploadPath) 
            ? selectedFile.Name 
            : $"{uploadPath.TrimEnd('/')}/{selectedFile.Name}";

        try
        {
            // Verificar se arquivo j√° existe
            bool fileExists = await S3Service.ObjectExistsAsync(selectedProfile, BucketName, objectKey);
            if (fileExists)
            {
                // Mostrar modal de confirma√ß√£o
                existingFileName = selectedFile.Name;
                showConfirmationModal = true;
                StateHasChanged();
                return;
            }

            // Se n√£o existe, proceder com upload
            await PerformUpload();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao verificar se arquivo existe: {FileName}", selectedFile?.Name);
            uploadErrorMessage = $"Erro ao verificar arquivo: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task PerformUpload()
    {
        if (selectedFile == null) return;

        try
        {
            isUploading = true;
            uploadErrorMessage = string.Empty;
            uploadSuccessMessage = string.Empty;
            StateHasChanged();

            // Construir chave do objeto
            var objectKey = string.IsNullOrEmpty(uploadPath) 
                ? selectedFile.Name 
                : $"{uploadPath.TrimEnd('/')}/{selectedFile.Name}";

            // Determinar tipo de conte√∫do
            var contentType = !string.IsNullOrEmpty(selectedFile.Type) 
                ? selectedFile.Type 
                : "application/octet-stream";

            // Ler arquivo como base64
            var base64Data = await JSRuntime.InvokeAsync<string>("readFileAsBase64", "fileUploadInput");
            if (string.IsNullOrEmpty(base64Data))
            {
                uploadErrorMessage = "Erro ao ler o arquivo selecionado.";
                return;
            }

            // Converter base64 para bytes
            var fileBytes = Convert.FromBase64String(base64Data);
            
            _logger.LogInformation("Iniciando upload de {FileName} ({Size} bytes) para {BucketName}/{Key}", 
                selectedFile.Name, fileBytes.Length, BucketName, objectKey);

            // Fazer upload usando CancellationToken com timeout generoso
            using var cts = new CancellationTokenSource(TimeSpan.FromMinutes(20));
            
            var uploadTask = Task.Run(async () => 
            {
                await S3Service.UploadObjectAsync(selectedProfile, BucketName, objectKey, fileBytes, contentType);
            }, cts.Token);

            // Aguardar com timeout
            await uploadTask;

            _logger.LogInformation("Upload conclu√≠do com sucesso para {FileName}", selectedFile.Name);

            // Mostrar sucesso temporariamente
            uploadSuccessMessage = $"Arquivo '{selectedFile.Name}' enviado com sucesso!";
            StateHasChanged();
            
            // Aguardar um pouco para mostrar a mensagem de sucesso
            await Task.Delay(2000);
            
            // Fechar modal e recarregar objetos
            CloseUploadModal();
            await LoadObjects();
        }
        catch (OperationCanceledException)
        {
            _logger.LogWarning("Upload cancelado para {FileName}", selectedFile?.Name);
            uploadErrorMessage = "O upload foi cancelado por timeout (20 minutos). Tente novamente com um arquivo menor.";
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("timeout"))
        {
            _logger.LogError(ex, "Timeout no upload de {FileName}", selectedFile?.Name);
            uploadErrorMessage = "Timeout no upload. Tente novamente ou verifique sua conex√£o de internet.";
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro no upload de {FileName}", selectedFile?.Name);
            uploadErrorMessage = $"Erro ao enviar arquivo: {ex.Message}";
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmOverwrite()
    {
        showConfirmationModal = false;
        StateHasChanged();
        await PerformUpload();
    }

    private void CancelUpload()
    {
        showConfirmationModal = false;
        existingFileName = string.Empty;
        StateHasChanged();
    }

    private void ConfirmDeleteObject(S3Object obj)
    {
        objectToDelete = obj;
        showDeleteConfirmationModal = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        showDeleteConfirmationModal = false;
        objectToDelete = null;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (objectToDelete == null) return;

        try
        {
            isDeleting = true;
            deletingObjects.Add(objectToDelete.Key);
            StateHasChanged();

            _logger.LogInformation("Iniciando exclus√£o do arquivo {FileName} do bucket {BucketName}", 
                objectToDelete.FileName, BucketName);

            bool success = await S3Service.DeleteObjectAsync(selectedProfile, BucketName, objectToDelete.Key);

            if (success)
            {
                _logger.LogInformation("Arquivo {FileName} exclu√≠do com sucesso", objectToDelete.FileName);
                
                // Fechar modal
                showDeleteConfirmationModal = false;
                objectToDelete = null;
                
                // Recarregar objetos
                await LoadObjects();
                
                // Mostrar mensagem de sucesso temporariamente
                errorMessage = string.Empty;
                StateHasChanged();
            }
            else
            {
                errorMessage = $"Falha ao excluir o arquivo '{objectToDelete.FileName}'.";
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao excluir arquivo {FileName}", objectToDelete?.FileName);
            errorMessage = $"Erro ao excluir arquivo: {ex.Message}";
        }
        finally
        {
            if (objectToDelete != null)
            {
                deletingObjects.Remove(objectToDelete.Key);
            }
            isDeleting = false;
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }


}
